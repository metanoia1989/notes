看了vagrant的开始指南后，简单的安装下载box，基本配置都回了，但想熟悉一点，虽然底层的技术细节自然是不懂的，不过文档中描述的适用，还是可以了解的。

想继续使用jekyll博客，并且恢复之前删除的笔记，wordpress的博客样式一直没有时间去看，不知道什么时候能够抽空解决一下。

下载box的好办法是，先add，然后把链接挂迅雷上。

# Providers
## virtualbox providers
By default, VirtualBox machines are started in headless mode, meaning there is no UI for the machines visible on the host machine. 
You can easily tell the VirtualBox provider to boot with a GUI:
```
 config.vm.provider "virtualbox" do |vb|
  vb.gui = true
  vb.name = "my_vm"
end
```

Linked clones are based on a master VM, which is generated by importing the base box only once the first time it is required. For the linked clones only differencing disk images are created where the parent disk image belongs to the master VM.
```
config.vm.provider "virtualbox" do |vb|
  vb.linked_clone = true
end
```


VBoxManage is a utility that can be used to make modifications to VirtualBox virtual machines from the command line.
```
config.vm.provider "virtualbox" do |vb|
  vb.customize ["modifyvm", :id, "--cpuexecutioncap", "50"]
  vb.memory = 1024
  vb.cpus = 2 
end
```
In the example above, the VM is modified to have a host CPU execution cap of 50%, meaning that no matter how much CPU is used in the VM, no more than 50% would be used on your own host machine. 

vboxmanage https://www.virtualbox.org/manual/ch08.html


The Vagrant VirtualBox provider supports using the private network as a VirtualBox internal network. 
```
Vagrant.configure("2") do |config|
  config.vm.network "private_network", ip: "192.168.50.4",
#    virtualbox__intnet: "mynetwork"
    virtualbox__intnet: true
end
```


You can specify a specific NIC type for the created network interface by using the nic_type parameter. This is not prefixed by virtualbox__ for legacy reasons, but is VirtualBox-specific.
```
Vagrant.configure("2") do |config|
  config.vm.network "private_network", ip: "192.168.50.4",
    nic_type: "virtio"
end
```

## docker providers
vagrant up --provider=docker 
use to source a Docker container is via an image. 
```
Vagrant.configure("2") do |config|
  config.vm.provider "docker" do |d|
    d.image = "foo/bar"
  end
end
```

Vagrant can also automatically build and run images based on a local Dockerfile. 
The Dockerfile is rebuilt when vagrant reload is called.
```
Vagrant.configure("2") do |config|
  config.vm.provider "docker" do |d|
    d.build_dir = "."
  end
end
```

The Docker provider does not require a Vagrant box. The config.vm.box setting is completely optional.

Docker Configuration
build_dir (string) - The path to a directory containing a Dockerfile. One of this or image is required.
image (string) - The image to launch, specified by the image ID or a name such as ubuntu:12.04. One of this or build_dir is required.

docker 需要一些docker基础，不然不好用


# Command-Line Interface
## box
vagrant box add ADDRESS 
vagrant box list
vagrant box prune - removes old versions of installed boxes.
vagrant box remove NAME - removes a box from Vagrant that matches the given name.
vagrant box repackage NAME PROVIDER VERSION 
vagrant box update 

## Connect
连接vagrant的分享环境
vagrant connect NAME
--static-ip IP
--ssh


## Init
vagrant init [name [url]]
This initializes the current directory to be a Vagrant environment by creating an initial Vagrantfile if one does not already exist.
first argument  =>  config.vm.box setting
second argument => config.vm.box_url

--force - If specified, this command will overwrite any existing Vagrantfile.
--minimal - If specified, a minimal Vagrantfile will be created. This Vagrantfile does not contain the instructional comments that the normal Vagrantfile contains.
--output FILE - This will output the Vagrantfile to the given file. If this is "-", the Vagrantfile will be sent to stdout.

## Up
vagrant up [name|id]
This command creates and configures guest machines according to your Vagrantfile.
--provider x - Bring the machine up with the given provider. By default this is "virtualbox".

## Halt
vagrant halt [name|id]
This command shuts down the running machine Vagrant is managing.
if the --force flag is specified, Vagrant will effectively just shut off power to the machine.

## Reload
vagrant reload [name|id]
The equivalent of running a halt followed by an up.
The configured provisioners will not run again, by default. You can force the provisioners to re-run by specifying the --provision flag.
--provision - Force the provisioners to run.
--provision-with x,y,z - This will only run the given provisioners. For example, if you have a :shell and :chef_solo provisioner and run vagrant reload --provision-with shell, only the shell provisioner will be run.

## Resume
vagrant resume [name|id]
This resumes a Vagrant managed machine that was previously suspended, perhaps with the suspend command.

## Suspend
vagrant suspend [name|id]
This suspends the guest machine Vagrant is managing, rather than fully shutting it down or destroying it.

## Destroy
销毁虚拟机
vagrant destroy [name|id]
-f or --force - Do not ask for confirmation before destroying.
--[no-]parallel - Destroys multiple machines in parallel if the provider supports it.

## Status
vagrant status [name|id]
This will tell you the state of the machines Vagrant is managing.

## Global Status
vagrant global-status
This command will tell you the state of all active Vagrant environments on the system for the currently logged in user.
--prune - Prunes invalid entries from the list. This is much more time consuming than simply listing the entries.

The IDs in the output that look like a1b2c3 can be used to control the Vagrant machine from anywhere on the system. Any Vagrant command that takes a target machine (such as up, halt, destroy) can be used with this ID to control it. For example: vagrant destroy a1b2c3.

## Port
vagrant port [name|id]
The port command displays the full list of guest ports mapped to the host machine ports
In a multi-machine Vagrantfile, the name of the machine must be specified
--guest PORT  This displays just the host port that corresponds to the given guest port. If the guest is not forwarding that port, an error is returned.
```
$ ssh -p $(vagrant port --guest 22)
```

## SSH
vagrant ssh [name|id] [-- extra_ssh_args]
This will SSH into a running Vagrant machine and give you access to a shell.
-c COMMAND or --command COMMAND - This executes a single SSH command, prints out the stdout and stderr, and exits.
-p or --plain - This does an SSH without authentication, leaving authentication up to the user.

nohup 命令可以让shell在后台执行，而在shell参数中加入 & 将会立即终止。

## SSH Config
vagrant ssh-config [name|id]
This will output valid configuration for an SSH config file to SSH into the running Vagrant machine from ssh directly (instead of using vagrant ssh).

## Provision
vagrant provision [vm-name]
Runs any configured provisioners against the running Vagrant managed machine.
--provision-with x,y,z - This will only run the given provisioners.

## Snapshot
vagrant snapshot
his is the command used to manage snapshots with the guest machine. This lets you experiment and try things and quickly restore back to a previous state.

vagrant snapshot push - This takes a snapshot and pushes it onto the snapshot stack.

vagrant snapshot pop - This command is the inverse of vagrant snapshot push: it will restore the pushed state.
--no-delete - Prevents deletion of the snapshot after restoring (so that you can restore to the same point again later).

vagrant snapshot save [vm-name] NAME - This command saves a new named snapshot. If this command is used, the push and pop subcommands cannot be safely used.

vagrant snapshot restore [vm-name] NAME 
vagrant snapshot list
vagrant snapshot delete NAME

## Share
vagrant share
The share command initializes a Vagrant Share session, allowing you to share your Vagrant environment with anyone in the world, enabling collaboration directly in your Vagrant environment in almost any network environment.
--disable-http - Disables the creation of a publicly accessible HTTP endpoint to your Vagrant environment. With this set, the only way to access your share is with vagrant connect.

--http PORT - The port of the HTTP server running in the Vagrant environment. By default, Vagrant will attempt to find this for you. This has no effect if --disable-http is set.

--https PORT - The port of an HTTPS server running in the Vagrant environment. By default, Vagrant will attempt to find this for you. This has no effect if --disable-http is set.

--ssh - Enables SSH sharing (more information below). By default, this is not enabled.

--ssh-no-password - Disables the encryption of the SSH keypair created when SSH sharing is enabled.

--ssh-port PORT - The port of the SSH server running in the Vagrant environment. By default, Vagrant will attempt to find this for you.

--ssh-once - Allows SSH access only once. After the first attempt to connect via SSH to the Vagrant environment, the generated keypair is destroyed.

## Login
vagrant login
Logging is only necessary if you are accessing protected boxes or using Vagrant Share.

--check This will check if you are logged in.the command will have exit status 0 if you are logged in, and exit status 1 if you are not.
--logout - This will log you out if you are logged in. 
--token - This will set the Vagrant Cloud login token manually to the provided string. It is assumed this token is a valid Vagrant Cloud access token.


## Plugin
vagrant plugin
expunge 清空  
install
license
list
repair 修补
uninstall
update

## Other
vagrant version - 输出vagrant的版本信息
vagrant validate - 验证 Vagrantfile 语法.
vagrant rsync - 强制重新同步 synced folders. change any settings will need to vagrant reload before
vagrant rsync-auto - 自动同步


# Vagrant Share
Vagrant Share allows you to share your Vagrant environment with anyone in the world.
Vagrant Share requires ngrok to be used.
- HTTP sharing
- SSH sharing 
- General sharing

Just call vagrant share --full. This will automatically share as many ports as possible for remote connections.
They simply have to call vagrant connect NAME. This will give them a static IP they can use to access your Vagrant environment.

## HTTP Sharing
"HTTP sharing," and is enabled by default when vagrant share is used.
If Vagrant has trouble detecting the port of your servers in your environment, use the --http and/or --https flags to be more explicit.

If you want to disable the creation of the publicly accessible endpoint, run vagrant share with the --disable-http flag. 

vagrant share by default looks for any SSL traffic on port 443 in your development environment. If it cannot find any, then SSL is disabled by default.

The HTTPS share can be explicitly disabled using the --disable-https flag.

## SSH Sharing
Vagrant share makes it trivially easy to allow remote SSH access to your Vagrant environment by supplying the --ssh flag to vagrant share.

Anyone can then SSH directly to your Vagrant environment by running vagrant connect --ssh NAME where NAME is the name of the share outputted previously.

# Push
As of version 1.7, Vagrant is capable of deploying or "pushing" application code in the same directory as your Vagrantfile to a remote such as an FTP server.
推送Vagrantfile同目录下的应用代码到远程FTP服务，也就是说实现了ftp的上传功能。

Here is an example Vagrant Push configuration section in a Vagrantfile:
```ruby
config.push.define "ftp" do |push|
  push.host = "ftp.company.com"
  push.username = "..."
  # ...
end
```
> $ vagrant push

Much like Vagrant Providers, Vagrant Push also supports multiple backend declarations. Consider the common scenario of a staging and QA environment:
```ruby
config.push.define "staging", strategy: "ftp" do |push|
  # ...
end

config.push.define "qa", strategy: "ftp" do |push|
  # ...
end
```
> $ vagrant push staging

## push支持 ftp 和 sftp 服务
- host - The address of the remote (S)FTP server. If the (S)FTP server is running on a non-standard port, you can specify the port after the address (host:port).
- username - The username to use for authentication with the (S)FTP server.
- password - The password to use for authentication with the (S)FTP server.
- passive - Use passive FTP (default is true).
- secure - Use secure (SFTP) (default is false).
- destination - The root destination on the target system to sync the files (default is /).
- exclude - Add a file or file pattern to exclude from the upload, relative to the dir. This value may be specified multiple times and is additive. exclude take precedence over include values.
- include - Add a file or file pattern to include in the upload, relative to the dir. This value may be specified multiple times and is additive.
- dir - The base directory containing the files to upload. By default this is the same directory as the Vagrantfile, but you can specify this if you have a src folder or bin folder or some other folder you want to upload.

## Local Exec Strategy
The Vagrant Push Local Exec strategy allows the user to invoke an arbitrary shell command or script as part of a push.
- script - The path to a script on disk (relative to the Vagrantfile) to execute. 
- inline - The inline script to execute (as a string).
- args (string or array) - Optional arguments to pass to the shell script when executing it as a single string. 
```ruby
# Remote path:
# 远程主机scp
config.push.define "local-exec" do |push|
  push.inline = <<-SCRIPT
    scp -r . server:/var/www/website
  SCRIPT
end

# Local path:
# 本地主机cp
config.push.define "local-exec" do |push|
  push.inline = <<-SCRIPT
    cp -r . /var/www/website
  SCRIPT
end

# disk script
config.push.define "local-exec" do |push|
  push.script = "my-script.sh"
end
```

# Multi-Machine
Vagrant is able to define and control multiple guest machines per Vagrantfile. This is known as a "multi-machine" environment.
- Accurately modeling a multi-server production topology, such as separating a web and database server.
- Modeling a distributed system and how they interact with each other.
- Testing an interface, such as an API to a service component.
- Disaster-case testing: machines dying, network partitions, slow networks, inconsistent world views, etc.

Multiple machines are defined within the same project Vagrantfile using the config.vm.define method call.
```ruby
Vagrant.configure("2") do |config|
  config.vm.provision "shell", inline: "echo Hello"

  config.vm.define "web" do |web|
    web.vm.box = "apache"
  end

  config.vm.define "db" do |db|
    db.vm.box = "mysql"
  end
end
```

# Synced Folders
Synced folders enable Vagrant to sync a folder on the host machine to the guest machine, allowing you to continue working on your project's files on your host machine, but use the resources in the guest machine to compile or run your project.

By default, Vagrant will share your project directory (the directory with the Vagrantfile) to /vagrant.

## Basic Usage
Synced folders are configured within your Vagrantfile using the config.vm.synced_folder method. 
```ruby
Vagrant.configure("2") do |config|
  # other config here

  config.vm.synced_folder "src/", "/srv/website"
end
```
The first parameter is a path to a directory on the host machine. 
The second parameter must be an absolute path of where to share the folder within the guest machine.This folder will be created (recursively, if it must) if it does not exist.

Options, You may also specify additional optional parameters when configuring synced folders. 
note the owner/group example supplies two additional options separated by commas.
- create (boolean) - If true, the host path will be created if it does not exist. Defaults to false.
- disabled (boolean) - If true, this synced folder will be disabled and will not be setup. This can be used to disable a previously defined synced folder or to conditionally disable a definition based on some external factor.
- group (string) - The group that will own the synced folder. By default this will be the SSH user. Some synced folder types do not support modifying the group.
- mount_options (array) - A list of additional mount options to pass to the mount command.
- owner (string) - The user who should be the owner of this synced folder. By default this will be the SSH user. Some synced folder types do not support modifying the owner.
- type (string) - The type of synced folder. If this is not specified, Vagrant will automatically choose the best synced folder option for your environment. Otherwise, you can specify a specific type such as "nfs".
- id (string) - The name for the mount point of this synced folder in the guest machine. This shows up when you run mount in the guest machine.

Disabling, Synced folders can be disabled by adding the disabled option to any definition
```ruby
Vagrant.configure("2") do |config|
  config.vm.synced_folder "src/", "/srv/website", disabled: true
end
```

Modifying the Owner/Group
By default, Vagrant mounts the synced folders with the owner/group set to the SSH user. Sometimes it is preferable to mount folders with a different owner and group. It is possible to set these options:
```ruby
config.vm.synced_folder "src/", "/srv/website",
  owner: "root", group: "root"

# NOTE: Owner and group IDs defined within mount_options will have precedence over the owner and group options.
config.vm.synced_folder ".", "/vagrant", owner: "vagrant",
  group: "vagrant", mount_options: ["uid=1234", "gid=1234"]
```

Symbolic Links


# Creating a Base Box
Packer，自动化的box构建工具

Before installing the guest additions, you will need the linux kernel headers and the basic developer tools. On Ubuntu, you can easily install these like so:
> $ sudo apt-get install linux-headers-$(uname -r) build-essential dkms

Where "my-virtual-machine" is replaced by the name of the virtual machine in VirtualBox to package as a base box.
> $ vagrant package --base my-virtual-machine

vagrant package [name|id]
--base NAME - Instead of packaging a VirtualBox machine that Vagrant manages, this will package a VirtualBox machine that VirtualBox manages. NAME should be the name or UUID of the machine from the VirtualBox GUI. Currently this option is only available for VirtualBox.
--output NAME - The resulting package will be saved as NAME. By default, it will be saved as package.box.
--vagrantfile FILE - Packages a Vagrantfile with the box, that is loaded as part of the Vagrantfile load order when the resulting box is used.

A VirtualBox base box is an archive of the resulting files of exporting a VirtualBox virtual machine. Here is an example of what is contained in such a box:
```sh
$ tree
.
|-- Vagrantfile
|-- box-disk1.vmdk
|-- box.ovf
|-- metadata.json
```

## Default User Settings
"vagrant" User
Default, it is a general convention to set the password for the "vagrant" user to "vagrant". 
Place the public key into the ~/.ssh/authorized_keys file for the "vagrant" user. Note that OpenSSH is very picky about file permissions. Therefore, make sure that ~/.ssh has 0700 permissions and the authorized keys file has 0600 permissions.

Root Password: "vagrant"
Vagrant does not actually use or expect any root password. However, having a generally well known root password makes it easier for the general public to modify the machine if needed.

Password-less Sudo
This is important!. Many aspects of Vagrant expect the default SSH user to have passwordless sudo configured. This lets Vagrant configure networks, mount synced folders, install software, and more.


This can be done with the following line at the end of the configuration file:
vagrant ALL=(ALL) NOPASSWD: ALL
